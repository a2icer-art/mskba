# Процессы

Ниже описаны основные процессы, реализованные в проекте на текущий момент.

## Регистрация
1. Пользователь вводит `login`, пароль и опционально email, выбирает роль участника (необязательно).
2. Создается пользователь и профиль.
3. Пользователь автоматически авторизуется и попадает в аккаунт.

### Требования к данным
- `login`: уникальный, используется как основной идентификатор.
- `password`: минимум 6 символов, содержит буквы и цифры.
- `email`: опционально, стандартная валидация.

## Авторизация
1. Вход по `login` и паролю.
2. При ошибке показывается сообщение в модальном окне.

## Передача контекста в UI
- Если в UI/презентационный слой передается `User`, то производные параметры (например, `roleLevel`,
  `permissions`) в контроллере не вычисляются и могут передаваться как `null`; слой обязан получить их
  из `User`, если они не заданы явно.

## Аккаунт
1. В боковом меню доступны разделы: Пользователь, Профиль, Контакты, роли участника.
2. Активный раздел определяется маршрутом (Inertia).

## Редактирование профиля пользователя
1. В разделе «Профиль» доступна кнопка «Редактировать».
2. Для неподтвержденного пользователя доступны все поля профиля.
3. Для подтвержденного пользователя доступны только необязательные поля профиля.
4. Пароль редактируется отдельно с валидацией.

## Управление контактами
1. Добавление контакта: выбор типа и значения, валидация уникальности в рамках пользователя и типа.
2. Редактирование возможно только для неподтвержденных контактов.
3. Удаление возможно только для неподтвержденных контактов.

## Подтверждение контакта
1. Нажатие «Подтвердить» создаёт запись подтверждения и генерирует код.
2. До истечения TTL повторный запрос недоступен; показывается таймер ожидания.
3. Неверный код увеличивает счетчик попыток; показывается остаток попыток.
4. При исчерпании попыток поле ввода блокируется, кнопка подтверждения скрывается.
5. Корректный код подтверждает контакт и показывает бейдж подтверждения.

### Технические детали
- Генерация и проверка кода выполняется на бэкенде.
- Отправка кода реализована через заглушки по типам контактов.
- История действий фиксируется аудитом.

## Модерация пользователя
1. В аккаунте доступна кнопка «Отправить на модерацию» для неподтвержденного пользователя.
2. Перед отправкой проверяются требования:
   - запрос отправляет владелец аккаунта;
   - пользователь не подтвержден и не заблокирован;
   - есть хотя бы один подтвержденный контакт;
   - профиль заполнен (фамилия, имя, пол, дата рождения).
3. При успехе создается запись в `moderation_requests` со статусом `pending`, в UI показывается бейдж «На модерации».
4. При ошибке возвращается список невыполненных требований и показывается уведомление под кнопкой.
5. При отклонении заявки:
   - если есть причина отклонения — появляется кнопка «Отправить повторно» и текст причины;
   - если причины нет — показывается бейдж «Отклонено» и пояснение, что повторная отправка недоступна.
6. При подтверждении заявки пользователь получает статус `confirmed`, в аккаунте отображается дата подтверждения.

### Модерация в Admin
- Раздел `/admin/users-moderation`: фильтры, сортировка и пагинация заявок.
- Действия: «Подтвердить», «Отклонить» (с необязательной причиной), «Заблокировать/Разблокировать» (с причиной).
- При блокировке в аккаунте отображается причина блокировки или сообщение по умолчанию.

## Модерация площадок
1. В Admin отображается список заявок на модерацию площадок.
2. Доступны фильтры по статусу и сортировка по дате отправки.
3. Модератор может подтвердить или отклонить заявку; при отклонении опционально указывается причина.
4. При подтверждении площадке выставляется статус `confirmed` и фиксируется подтверждающий пользователь.
5. При отклонении площадка возвращается в статус `unconfirmed`.

## Модерация контрактов площадки
1. Типы контрактов площадки: `создатель`, `владелец`, `супервайзер`, `сотрудник`.
2. Контракты `владелец` и `супервайзер` назначаются только через модерацию `/admin/contracts-moderation`.
3. Запрос на владельца может подать пользователь с ролью «администратор площадки», если у подтвержденной площадки нет активного владельца.
4. Запрос на супервайзера может подать подтвержденный пользователь без активного контракта на площадке, если нет активного супервайзера.
5. В запросе указывается комментарий, статус отображается в разделе контрактов площадки.
6. Модератор подтверждает или отклоняет запрос; при подтверждении назначает права и период действия контракта:
   - для владельца — любые права площадки;
   - для супервайзера — только права, связанные с бронированиями.
7. По результатам модерации и по изменениям контрактов отправляются системные уведомления инициатору и модератору.
8. Фоновая задача актуализирует статус контрактов по `ends_at` и переводит просроченные в `inactive`.

## Каталог площадок
1. Страница `/venues` показывает все площадки.
2. Страницы `/venues/<type>` фильтруют по типу.
3. В боковом меню типов активный пункт подсвечивается.

### Навигация по типам
- Название пункта меню берется из `plural_name`, при отсутствии — из `name`.
- URL формируется по `alias` типа с приведением к множественному числу.

## Создание площадки
1. Подтвержденный пользователь нажимает кнопку «Добавить площадку» на `/venues`.
2. В модальном окне заполняются обязательные поля: название, тип, адрес.
3. После создания выполняется переход на страницу площадки со статусом и действиями модерации.

## Расписание площадки
1. Публичное расписание: `/venues/<type>/<venue>/schedule` — доступно без авторизации, показывает календарь и попап бронирования по дням.
2. Административное расписание: `/venues/<type>/<venue>/admin/schedule` — доступно при праве `venue.schedule.manage`, иначе 403.
3. В админ-расписании доступны недельные интервалы и исключения, календарь отображает занятость и статусы.

## Бронирование: оплата и подтверждение (текущая модель)
1. У площадки задан порядок оплаты по умолчанию: предоплата (полная), частичная предоплата или постоплата.
2. Для заявки на бронирование порядок оплаты может быть выбран менеджером площадки при переводе заявки в работу.
3. Постоплата не подтверждает бронирование автоматически: подтверждение выполняется отдельным действием менеджера.
4. Предоплата (полная/частичная) сейчас трактуется одинаково: оплата происходит вне системы (наличные/перевод), а менеджер вручную ставит статус «оплачено».
5. Система пока не учитывает частичные суммы: фиксируется только факт оплаты и статус бронирования.
6. Для безналичных расчетов пользователь может указывать номер оплаты, который генерируется в интерфейсе для учета.
7. Для заявок `pending` действует автоотмена:
   - по времени рассмотрения (`pending_review_minutes`, учитывается рабочее время площадки);
   - по приближению к старту (`pending_before_start_minutes`).
8. За `pending_warning_minutes` до автоотмены отправляется системное предупреждение (0 — не отправлять).
