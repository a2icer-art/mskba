# task_name
Контракты площадки: новые типы и модерация

# task_status
[...]

# task_init_description
#set_task Я долго думал и пришел к выводу, что все таки нужно переосмысление набора типов контракта для площадки и порядка работы с правами контракта.

Типы контракта для площадки должны быть следующие: создатель, владелец, супервайзер и сотрудник. 
Контракты типа "владелец" и "супервайзер" создатель площадки назначать не может,
они создаются в результате запроса в центр модерации /admin/contracts-moderation согласно нижеописанного сценария.

Для понимания: 
- Владелец - это юрлицо, которое должно подтвердить право владения площадкой, предоставив документы и юридические данные любым способом. 
На данный момент, чтобы не усложнять процесс разработки, предлагается следующий сценарий: 
Если у площадки (подтвержденной) нет активного договора с типом "владелец" - 
любой зарегистрированный пользователь с наличием роли "администратор площадки" может подать запрос в центр модерации на установку контракта с типом "владелец".
Для этого на странице "контрактов площадки" (например тут: /venues/halls/na-dubninskoi/contracts) должна быть соответствующая кнопка, нажатие которой открывает попап с формой, в которой можно добавить комментарий. Сабмит данной формы (попапа) создает запрос в модерационный центр, а кнопка для этого пользователя меняется на отображение статуса и комментария, например: "На рассмотрении" или "Отклонено + комментарий: предоставьте подтверждающие документы владения на такую-то почту". 
Пользователи, имеющие доступ к админ-панели: /admin/contracts-moderation (admin или moderator), видят данный запрос в таблице запросов (интерфейс и UI/UX такой же как и у других модерационных разделов, например: /admin/venues-moderation или /admin/users-moderation и могут подтвердить или отклонить с комментарием, например: "пришлите карточку юрлица и/или подтверждающие документы в почте moderation@mskba.ru"). 

После чего пользователь заявивший права владения, например, выполняет то, что от него требуется, например, идет в почту и отправляет письмо согласно требованию указаному в причине отклонения - далее admin или moderator, получив это письмо на эл. почту, принимает решение подтвердить права владения (эта договоренность выполняется вне проекта, и может разрешиться даже по звонку между участниками). 
Нажимая на кнопку "подтвердить" ответственный пользователь (admin или moderator), получает попап в котором также можно указать комментарий и назначить любые из доступных прав по площадке, включая аннулирование контрактов и редактирование прав контрактов - причем эти права абсолютны и применимы даже к контракту типа "создатель".

- Супервайзер - это посредник (агент), который будет "вести" площадку на предмет обработки заявок на бронирование - согласование времени и решение различных вопросов в реальном (физическом) мире (вне проекта или внутри в мессенджере - не важно).
Активный контракт типа "супервайзер", как и "владелец", может быть только один у площадки.
Для того чтобы стать супервайзером используется та же технология (те же процессы) что описаны и для владельца, за исключением двух вещей: 
- супервайзером может стать любой подтвержденный пользователь, кроме того, у кого уже есть активный контракт с площадкой, 
- при подтверждении запроса на модерацию на становление супервайзером список прав ограничен теми, что имеют отношение к бронированию.

В sidebar-е площадки в группе "администрация" добавляется еще один раздел "супервайзер", доступ к которому, в том числе отображение пункта в sidebar-е площадки будет у тех у кого есть соответствующее право. Нужно добавить два права на площадку - "просмотр супервайзинга" и "настройка супервайзинга".

Касаемо уведомлений, которые будут порождаться следующими событиями: 
- После изменения статуса модерации заявки - создается системное уведомление/сообщение типа "Изменение статуса модерации", которое отправляется пользователю по запросу которого произошли изменения и тому, кто эти изменения произвел, также как и в процессе бронирования площадки для пользователя у которого были изменены права - внизу указаны контакты того, кто изменил права, а для того кто изменил права внизу указан контакт того, кто изменил права для удобного перехода в личные сообщения.
- Изменение прав у контрактов других пользователей, назначение или аннулирование контракта - порождает системное уведомление/сообщение типа "Изменение прав контракта", "Назначение контракта" или "Аннулирование контракта" а в теле сообщения информация и ссылки на сущность и/или подробное раскрытие манипуляции, которое отправляется двум пользователям: пользователю, к контракту которого была применена манипуляция и тому, кто эту манипуляцию произвел. 
Также как и в процессе бронирования площадки, для пользователя к контракту которого была применена манипуляция - внизу диалога указаны кликабельные контакты того, кто эту манипуляция произвел, а для того кто произвел манипуляцию - контакт того, к чьему контракту была применена манипуляция - для удобного перехода в личные сообщения. 
Как и раньше активный владелец у площадки может быть только один.

# task_short_description
Переосмыслить типы контрактов площадки (создатель/владелец/супервайзер/сотрудник), добавить модерацию заявок владельца/супервайзера, новые права и уведомления, а также UI для запросов и админ-панели.

# task_full_description
Нужно обновить модель контрактов площадки и связанный процесс: оставить типы `создатель`, `владелец`, `супервайзер`, `сотрудник`, удалить/заменить устаревшие типы и обеспечить корректную миграцию существующих контрактов. Контракты `владелец` и `супервайзер` назначаются только через модерацию, инициатором является пользователь с ролью администратор площадки (и/или подтвержденный пользователь в случае супервайзера), а утверждение выполняется админом или модератором в отдельном разделе `/admin/contracts-moderation`.

Для владельца: если у подтвержденной площадки нет активного владельца, пользователь с ролью администратор площадки может создать запрос на владельца через форму на странице контрактов площадки. Запрос получает статус (на рассмотрении/отклонено/подтверждено) и комментарии. При подтверждении модератор может назначить любые доступные права по площадке, включая управление контрактами, и эти права должны быть абсолютными, применимыми даже к контракту типа создатель.

Для супервайзера: активный контракт один на площадку. Запросы проходят через тот же модерационный процесс, но список прав, назначаемых при подтверждении, ограничен правами, связанными с бронированием. Супервайзером может стать любой подтвержденный пользователь, не имеющий активного контракта на площадку.

Нужны новые права площадки: просмотр супервайзинга и настройка супервайзинга. В sidebar площадки (группа администрация) добавить раздел "Супервайзер" с доступом по этим правам.

Необходимо реализовать системные уведомления: изменение статуса модерации, назначение/изменение/аннулирование контрактов. Уведомления отправляются инициатору и модератору, либо владельцу контракта и действующему лицу, с указанием контактов для перехода в личные сообщения.

# План выполнения задачи
1. Группа A: Типы контрактов и миграция данных. См. `docs/tasks/084/subtasks/01_contract_types.md`.
2. Группа A: Реестр прав и ограничения назначений. См. `docs/tasks/084/subtasks/02_permissions_registry.md`.
3. Группа B: Домен и модель модерации контрактов. См. `docs/tasks/084/subtasks/03_contract_moderation_model.md`.
4. Группа B: Админ-раздел модерации контрактов. См. `docs/tasks/084/subtasks/04_admin_contracts_moderation.md`.
5. Группа C: UI площадки — запрос владельца/супервайзера. См. `docs/tasks/084/subtasks/05_venue_contracts_ui.md`.
6. Группа C: Раздел супервайзера в sidebar и права. См. `docs/tasks/084/subtasks/06_supervisor_section.md`.
7. Группа D: Бизнес-логика назначения/аннулирования и фильтры прав. См. `docs/tasks/084/subtasks/07_contracts_logic.md`.
8. Группа D: Системные уведомления и сообщения. См. `docs/tasks/084/subtasks/08_notifications.md`.
9. Группа E: Обновление документации и сценарии проверки. См. `docs/tasks/084/subtasks/09_docs_checks.md`.
