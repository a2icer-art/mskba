# AGENTS.md
Инструкция для AI-агента проекта
(Laravel + Inertia + Vue)


## Project overview (контекст проекта)

**MSKBA** — это баскетбольный цифровой портал и сервис для организации игр, тренировок и взаимодействия участников баскетбольного сообщества. Подробнее в проектной документации (_DPROJECT/overview.md)

---

## Absolute rules (обязательные правила)

- Все файлы проекта **обязательно** сохраняются в кодировке **UTF-8 без BOM**.
- Код, комментарии, строки, шаблоны и JSON/YAML-файлы **должны корректно поддерживать кириллицу**.
- Запрещено использовать кодировки Windows-1251, ISO-8859-* и любые другие, кроме UTF-8.
- При работе со строками:
  - не выполнять ручных перекодировок;
  - не использовать устаревшие функции, нарушающие UTF-8.
- Все изменения должны быть **минимальными и локальными**.
- Не выполнять рефакторинг или архитектурные изменения без явного запроса.
- **Никогда** не коммитить секреты, ключи, пароли, токены и доступы.
- При любых сомнениях — следовать существующим паттернам и структуре проекта.
- Перед началом работы сверяться с актуальной проектной документацией в `docs/project` и учитывать её требования.
- Task-ветки (`001`, `002`, …) храним локально и на GitHub, ответвляя их от `dev`. В `main` task-ветки не создаём и не держим (ни локально, ни на GitHub).

---

## Language rules (язык общения и разработки)

- **AI-агент обязан отвечать в чате на русском языке**, если пользователь не указал иное явно.
- Комментарии в коде, документация и markdown-файлы:
  - по умолчанию пишутся **на русском языке**;
  - допускается английский язык для:
    - общепринятых технических терминов;
    - публичных API / SDK;
    - случаев, где проект уже использует английский.
- Названия классов, методов, переменных — **только на английском** (Laravel / PHP conventions).

---

## Repo structure (conventions)

- _PROJECT — корень проекта

### Документация
- _DOCS — _PROJECT/docs
- _DTASKS — _DOCS/tasks
- _DPROJECT — _DOCS/project

Назначение:
- `_DPROJECT` — проектная документация: описание проекта, архитектура, договорённости, принципы
- `_DTASKS` — задачи, исследования, реализация, история решений по веткам

### Приватные конфиги
- _CONFIGS — _PROJECT/myconfigs
  - хранит приватные данные (FTP / SSH / env / интеграции)
  - **НЕ коммитится**
  - **НЕ деплоится**
  - использовать файлы:
    - _CONFIGS/ftp.md
    - _CONFIGS/ssh.md
    - _CONFIGS/env.md

---

## Stack

- Backend: Laravel
- Frontend: Inertia.js + Vue

---

## PHP autoloading and namespaces (PSR-4)

- PSR-4 обязателен без исключений.
- Namespace **строго** соответствует пути файла.
- Стандартные Laravel mappings:
  - App\ → app/
  - Database\Seeders\ → database/seeders/
  - Database\Factories\ → database/factories/
  - Tests\ → tests/
- Имя файла = имя класса.
- Один основной класс на файл (если не оговорено иное).
- Новые корневые namespace:
  - только при необходимости;
  - только с явным PSR-4 mapping в composer.json;
  - учитывать необходимость `composer dump-autoload`.

---

## Code style

### PHP
- PSR-12
- Laravel conventions
- Laravel Pint (preset: laravel), если присутствует в проекте

### Vue / JavaScript
- Следовать ESLint / Prettier конфигурации проекта
- Composition API
- `<script setup>`, если используется в проекте
- Именование:
  - Components — PascalCase
  - Composables — useXxx
  - Stores — useXxxStore

---

## Inertia.js conventions

- Сервер возвращает:
  - `Inertia::render('Path/To/Page', props)`
- Страницы:
  - `resources/js/Pages/**`
- Компоненты:
  - `resources/js/Components/**`
- Layouts:
  - `resources/js/Layouts/**`

(Если в проекте используются другие пути — следовать фактической структуре.)

---

## Laravel architecture rules

- `routes/web.php` — Inertia-страницы и web-endpoints
- `routes/api.php` — API
- Валидация:
  - предпочтительно `FormRequest`
- Контроллеры:
  - должны быть тонкими;
  - бизнес-логика выносится в Service / Action классы
- Работа с БД:
  - Eloquent ORM;
  - eager loading;
  - избегать N+1;
  - выбирать только необходимые поля.

---

## Architecture: DDD (Domain-driven modules)

В проекте используется DDD-подход в виде **доменных модулей**, размещённых в папке `app/Domain`.

### Зачем используется папка Domain
- `Domain` является **явной границей бизнес-логики**.
- Вся логика предметной области должна находиться внутри `app/Domain`, а не быть размазанной по `Http`, `Services`, `Helpers` и т.п.
- Папка `Domain` логически отделяет:
  - бизнес-правила проекта;
  - от технических слоёв Laravel (HTTP, консоль, провайдеры, инфраструктура).

### Общая структура
- `app/Domain/<DomainName>/`

Примеры доменов:
- `app/Domain/Orders`
- `app/Domain/Billing`
- `app/Domain/Users`

### Рекомендуемая структура домена
Внутри каждого доменного модуля могут использоваться следующие подпапки (по необходимости):

- `Models/` — доменные модели / агрегаты
- `Builders/` — кастомные Eloquent Query Builders
- `Services/` — переиспользуемая доменная логика
- `UseCases/` — бизнес-сценарии (точка входа в домен)
- `Resources/` — представление доменных данных
- `Events/` — доменные события
- `Enums/` — доменные перечисления
- `ValueObjects/` — объекты-значения
- `DTO/` — объекты передачи данных
- `Policies/` — доменные политики доступа
- `Contracts/` — интерфейсы домена
- `Infrastructure/` — технические реализации и интеграции

Структура не является строго обязательной, но **должна быть единообразной по проекту**.

### Namespaces (PSR-4)
- Namespace доменных классов должен соответствовать PSR-4:
  - `App\Domain\<DomainName>\...` → `app/Domain/<DomainName>/...`
- Имя файла всегда совпадает с именем класса.

### Правила и ограничения
- Контроллеры (`app/Http/Controllers`) должны быть **тонкими** и только:
  - принимать запрос;
  - вызывать доменные UseCases / Services;
  - возвращать ответ.
- Доменные классы:
  - **не должны зависеть** от HTTP-слоя (Request, Controller, Response);
  - не должны использовать Facades без крайней необходимости.
- Новая бизнес-логика:
  - добавляется **в существующий домен**, если он логически подходит;
  - новый домен создаётся только при явной необходимости.
- Не создавать домены и namespace «по одной таблице» без причины.
  Домены соответствуют **бизнес-областям**, а не каждой сущности БД.

### Запрещённые практики
- Размещение бизнес-логики в:
  - `Controllers`
  - `Http/Requests`
  - глобальных `Helpers`
- Создание абстрактных `Services` вне доменного контекста.

---

## Terminal encoding (PowerShell)
- Перед любыми операциями с файлами в PowerShell задавать UTF-8:
  - `$OutputEncoding = [System.Text.Encoding]::UTF8`
  - `chcp 65001` (если вывод/ввод всё равно ломается)
- При чтении/записи файлов в PowerShell всегда указывать `-Encoding utf8`.
- При Python-скриптах всегда использовать `encoding='utf-8'` для read/write.
- Дважды проверять корректность кириллицы: в UI в браузере и в текстах задач/подзадач/документации.

---
## Work modes (commands)

Режим указывается в начале запроса пользователя.

### Основные режимы
- `#plan` — анализ, архитектура, предложения (без изменения кода)
- `#execute` — реализация, изменение кода
- `#fix` — локальное исправление бага
- `#refactor` — рефакторинг без изменения поведения (только по явному запросу)
- `#docs` — работа только с документацией
- `#frontend` — только Vue / Inertia
- `#backend` — только Laravel

### Task-based режим
- `#set_task` — режим установки задачи
- `#execute_task` — режим выполнения задачи

#### Поведение в режиме #set_task
- Режим при котором необходимо проверить, что мы находимся в главной ветке - dev, иначе уведомить в чате
- В данном режиме мы работаем с файлом `_DTASKS/tasks/todo.md` устанавливаем задачу согласно промпта
- При добавлении задачи согласно промпта необходимо определить какого типа данная задача и записать ее в соответствующий блок файле `_DTASKS/tasks/todo.md`, если подходящего блока нет предложить название блока и при согласовании добавить его
- Добавить задачу в соответствующий блок с номером N+1 (если это первая задача - использовать 001). У создаваемой задачи должно отображаться название задачи (генерировать краткое название, отражающее суть) - task_name, статус - task_status, который устанавливает текущее выполнение задачи - новая [ ], выполнено - [x], в работе [...]. Если задача в работе и известен прогресс выполнения задачи в процентах (см. в папке задачи "окружение задачи" в файле task.md) - необходимо вместо многоточия писать текущий прогресс в процентах, например: [20%]
- Создать "окружение" для текущей задачи, а именно в `_DTASKS` необходимо создать папку с номером задачи в трехзначном формате. В этой папке создать файл description.md, в котором должен быть исходный текст задачи (task_init_description) и более подробное - краткое описание (task_short_description), которое необходимо создать на основании исходного текста задачи.

#### Поведение в режиме #execute_task
- данная команда может поступать в совокупности с модификаторами, тогда необходимо выполнить правило согласно описанным модификаторам ниже
- данная команда обязана поступать с указанием номера задачи, например: #execute_task:001, иначе номер задачи необходимо уточнить в чате. если указан номер несуществующей в списке todo.md задачи - необходимо также уточнить дальнейшие действия, предложить, например: создать задачу в todo согласно описанию из промпта
- Считается, что работа ведётся в рамках конкретной git-ветки.
- Необходимо:
  1. Убедиться, что мы находимся в соответствующей номеру задачи ветки, если это не так - проверить существует ли такая ветка (от dev), если не существует создать и переключится на нее 
  2. Проверить существует ли в `_DTASKS` соответствующая под задачу папка, если нет, то создать папку с именем **текущей ветки**:
     `_DOCS/tasks/<branch-name>/`
  3. Использовать эту папку для:
     - описания задачи;
     - фиксации решений;
     - промежуточных заметок;
     - итогов реализации.
  4. В папке выполняемой задачи необходимо создать файл task.md где будет продублированы task_name, task_status, task_init_description, task_short_description и пустая секция для подробного описания задачи full_description, где также возможны подзадачи, если задача составная или сложная.

> Подробный сценарий работы в режиме `#execute_task`
> будет описан и расширен позднее.

### Модификаторы
- `:no-commit` — не предлагать и не писать commit message
- `:no-doc` — не обновлять документацию
- `:expand_task` — расширить описание задачи, создав описание в секции full_description задачи на основании task_short_description
- `:plan_task` — данная команда подразумевает написание пошагового плана в секции в чате и после согласования его добавления в секцию План выполнения задачи - после секции full_description. При планировании выполнения задачи - если задача кажется сложной или составной необходимо разбить ее на подзадачи, под которые при выполнении задачи необходимо будет создать папку subtasks и связать план с соответствующими подзадачами (референс)
- `:execute` — подразумевает выполнение задачи согласно плана, указанного в секции План выполнения задачи, если данной секции в текущей задаче не обнаружено сперва выполнить команду модификатор :plan_task
- `:set_done` — завершить выполнение задачи: перевести в готовность статус выполнения задачи и всех связанных подзадач, затем уточнить про коммит и в случае одобрения (или если есть модификатор :no_spec - не уточнять насчет коммита) - коммитить, затем, после коммита замерджить текущую ветку в dev

Пример комбинации:
`#execute_task:[expand_task, plan_task, execute]`

---

## Output expectations

- Кратко указывать:
  - что изменено;
  - где;
  - зачем.
- Перечислять добавленные файлы.
- Если требуются ручные действия:
  - artisan-команды;
  - миграции;
  - сборка фронта;
  — указывать шаги явно.

---

## Priority

- AGENTS.md имеет приоритет над любыми неявными предположениями AI-агента.
- При конфликте инструкций — всегда следовать AGENTS.md.

---

## Task workflow (todo.md -> tasks)

- Общий список задач находится в `docs/tasks/dev/todo.md`.
- Каждая задача начинается в `dev`. Перед ответвлением создать папку задачи и `description.md`, скопировав описание из соответствующего пункта todo.
- Затем ответвиться от `dev` в ветку задачи.
- Первый шаг в ветке задачи: расширить `description.md` подробным описанием.
- Далее создать `task.md` с пошаговым планом. Каждый шаг должен ссылаться на файл подзадачи в `subtasks/`.
- Выполнение задачи должно порождать соответствующую проектную документацию, размещаемую в папке _DPROJECT со ссылками на задачу и коммиты

## Deploy CI/CD
-процесс CI/CD описан в файле /docs/project/deploy.md - необходимо ознакомиться дял понимания работы