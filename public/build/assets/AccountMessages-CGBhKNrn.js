import{u as ue,r as p,q as ae,s as de,c as D,p as T,w as $,x as ce,b as n,d as l,f as V,n as k,g as se,e as g,F as U,i as W,t as _,l as ve,j as fe,k as me,o as r,y as pe,m as ge,h as he,z as be}from"./app-BG8bJDk_.js";import{_ as _e}from"./Breadcrumbs-BJkTr2TQ.js";import{u as xe,_ as ye,a as ke}from"./MainHeader-CSzL04-A.js";import{_ as we}from"./MainSidebar-Gh5823Zl.js";const z=p(0),Se=(m={})=>{const i=ue(),M=m.intervalMs??5e3,X=m.autoStart??!0,v=Number.isFinite(Number(M))&&Number(M)>0,u=m.pollUrl??"/account/messages/poll",d=m.params??{},a=m.enabled??!0,h=p(!!a),x=m.onData;let w=null;const I=()=>{const y=i.props?.messageCounters?.unread_messages;Number.isFinite(Number(y))&&(z.value=Number(y))},b=async(y={},K={})=>{if(!h.value&&!K.force)return null;const q=new URLSearchParams({...d,...y}).toString(),H=q?`${u}?${q}`:u;try{const S=await fetch(H,{headers:{Accept:"application/json"}});if(!S.ok)return null;const N=await S.json();return Number.isFinite(Number(N?.unread_messages))&&(z.value=Number(N.unread_messages)),x&&x(N),N}catch{return null}},C=()=>{w||v&&(w=setInterval(b,M))},A=()=>{w&&(clearInterval(w),w=null)},j=()=>{h.value=!1,A()},B=(y={})=>{h.value=!0,y.pollNow&&b(),C()};return ae(()=>{I(),!(!h.value||!X)&&B({pollNow:!0})}),de(()=>{A()}),{unreadCount:z,poll:b,pause:j,resume:B}},Ce={class:"relative min-h-screen overflow-hidden bg-[#f7f1e6] text-slate-900"},Ne={class:"relative mx-auto flex max-w-[1360px] flex-col gap-8 px-6 py-8"},Te={class:"rounded-3xl border border-slate-200/80 bg-white/90 p-6 shadow-sm page-content-wrapper"},Me={class:"mt-6 grid gap-4 lg:grid-cols-[280px_1fr] lg:h-[600px]"},Ae={class:"flex h-full min-h-0 flex-col rounded-2xl border border-slate-200 bg-white p-4"},je={key:0,class:"mt-4 text-sm text-slate-500"},He={key:1,class:"mt-4 flex-1 space-y-3 overflow-auto pr-2"},Oe=["onClick"],Re={class:"flex items-center justify-between gap-2"},qe={key:0,class:"inline-flex h-5 min-w-[20px] items-center justify-center rounded-full bg-rose-500 px-1 text-[10px] font-semibold text-white"},Ee={class:"flex h-full min-h-0 flex-col rounded-2xl border border-slate-200 bg-white p-4"},De={key:0,class:"text-sm text-slate-500"},$e={key:1,class:"flex min-h-0 flex-1 flex-col gap-4 overflow-hidden"},Xe={class:"border-b border-slate-100 pb-3"},Be={class:"mt-1 text-lg font-semibold text-slate-900"},Fe={key:0,class:"flex min-h-[180px] items-center justify-center"},Le={key:0,class:"flex justify-center py-2"},Pe={key:1,class:"py-2 text-center text-xs text-slate-400"},Ue={key:0,class:"font-semibold"},Ie={class:"flex items-center gap-2"},Ke=["title"],Ve=["onClick"],We={key:0,class:"mt-auto space-y-3 rounded-2xl border border-dashed border-slate-200 bg-slate-50 px-4 py-3"},ze={class:"flex flex-wrap gap-2"},Je=["onClick"],Ge={class:"block text-sm"},Qe={key:0,class:"mt-1 block text-[10px] uppercase tracking-[0.12em] text-slate-500"},Ye={key:0,class:"text-xs text-slate-500"},Ze={key:0,class:"text-xs text-rose-700"},et={class:"flex justify-end"},tt=["disabled"],nt={__name:"AccountMessages",props:{appName:{type:String,default:"Laravel"},user:{type:Object,default:null},conversations:{type:Array,default:()=>[]},activeConversation:{type:Object,default:null},messages:{type:Array,default:()=>[]},messagesMeta:{type:Object,default:()=>({has_more:!1,oldest_id:null})},navigation:{type:Object,default:()=>({title:"Аккаунт",data:[]})},activeHref:{type:String,default:""},breadcrumbs:{type:Array,default:()=>[]}},setup(m){const i=m,M=D(()=>i.navigation?.data??i.navigation?.items??[]),X=D(()=>(M.value?.length??0)>0),v=p([...i.conversations]),u=p(i.activeConversation),d=p([...i.messages]),a=p(null),h=p(i.activeConversation?.id??null),x=p({...i.messagesMeta}),w=e=>{if(!e)return 0;const s=e.includes("T")?e:e.replace(" ","T"),t=Date.parse(s);return Number.isNaN(t)?0:t},I=D(()=>[...v.value].sort((e,s)=>{const t=w(e.last_message?.created_at||e.updated_at),c=w(s.last_message?.created_at||s.updated_at);return t!==c?c-t:(s.id??0)-(e.id??0)}));ae(()=>{if(T(()=>{a.value&&(a.value.scrollTop=a.value.scrollHeight)}),u.value?.id){const e=u.value.id;v.value=v.value.map(s=>s.id===e?{...s,unread_count:0}:s),H()}}),$(()=>i.conversations,e=>{v.value=[...e??[]],H()}),$(()=>i.activeConversation,e=>{u.value=e,h.value=e?.id??null}),$(()=>u.value?.id,e=>{e&&T(()=>{F(e)})},{immediate:!0}),$(()=>i.messages,e=>{d.value=[...e??[]]}),$(()=>i.messagesMeta,e=>{x.value={...e??{}}});const b=ce({include_conversations:1,conversation_id:i.activeConversation?.id??"",messages_after_id:i.messages?.length?i.messages[i.messages.length-1]?.id:""}),C=p(!1),A=p(!1),j=(e,s,t)=>{const c=new Set,f=[],o=R=>{!R||c.has(R.id)||(c.add(R.id),f.push(R))};return t==="prepend"?(s.forEach(o),e.forEach(o),f):t==="append"?(e.forEach(o),s.forEach(o),f):(s.forEach(o),f)},B=e=>{if(Array.isArray(e?.conversations)&&(v.value=e.conversations,H()),Array.isArray(e?.messages)){const s=a.value?a.value.scrollHeight-a.value.scrollTop-a.value.clientHeight<40:!0;e?.messages_mode==="prepend"?d.value=j(d.value,e.messages,"prepend"):e?.messages_mode==="append"?d.value=j(d.value,e.messages,"append"):d.value=j([],e.messages,"replace");const t=d.value[d.value.length-1];b.messages_after_id=t?.id??"",e?.messages_mode==="append"&&s&&T(()=>{a.value&&(a.value.scrollTop=a.value.scrollHeight)})}if(Array.isArray(e?.messages_refresh)&&e.messages_refresh.length){const s=new Map(e.messages_refresh.map(t=>[t.id,t]));d.value=d.value.map(t=>s.get(t.id)??t)}e?.active_conversation&&(u.value=e.active_conversation),Array.isArray(e?.messages)&&(C.value=!1),e?.messages_meta&&(x.value=e.messages_meta),u.value?.id&&F(u.value.id),Array.isArray(e?.messages)&&e?.messages_mode!=="prepend"&&e?.messages_mode!=="append"&&T(()=>{a.value&&(a.value.scrollTop=a.value.scrollHeight)})},y=e=>{if(!e?.id)return;const s=v.value;if(s.findIndex(c=>c.id===e.id)>=0){v.value=s.map(c=>c.id===e.id?{...c,...e}:c);return}v.value=[e,...s]},K=e=>{if(e?.event){if(e.event==="messages.created"){e.conversation&&y(e.conversation);const s=u.value?.id;if(e.conversation?.id&&e.conversation.id===s&&e.message){const t=a.value?a.value.scrollHeight-a.value.scrollTop-a.value.clientHeight<40:!0;d.value=j(d.value,[e.message],"append"),b.messages_after_id=e.message?.id??b.messages_after_id,t&&T(()=>{a.value&&(a.value.scrollTop=a.value.scrollHeight)}),e.message.is_outgoing||F(s)}return}if(e.event==="messages.read"){e.conversation&&y(e.conversation);const s=u.value?.id;e.conversation_id&&e.conversation_id===s&&e.reader_id!==i.user?.id&&(d.value=d.value.map(t=>!t.is_outgoing||t.read_by_others_at?t:{...t,read_by_others_at:e.read_at}))}}},{unreadCount:q}=xe({enabled:!!i.user?.id,onEvent:K}),H=()=>{const e=v.value.reduce((s,t)=>s+Number(t?.unread_count||0),0);q.value=e},{poll:S,pause:N,resume:J}=Se({pollUrl:"/account/messages/poll",params:b,onData:B,autoStart:!1,intervalMs:0}),G=e=>e.key==="messages"?{...e,badge:q.value}:e,Q=D(()=>M.value.map(e=>Array.isArray(e?.items)?{...e,items:e.items.map(G)}:G(e))),F=async e=>{if(!e||A.value)return;A.value=!0;const s=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");try{await fetch(`/account/messages/conversations/${e}/read`,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest",...s?{"X-CSRF-TOKEN":s}:{}}}),v.value=v.value.map(t=>t.id===e?{...t,unread_count:0}:t),H()}finally{A.value=!1}},Y=async e=>{C.value=!0,d.value=[],x.value={has_more:!1,oldest_id:null},h.value=e?.id??null,u.value=e,b.conversation_id=e?.id??"",b.messages_after_id="",await F(e?.id),N();try{await S({conversation_id:e?.id,include_conversations:0},{force:!0})}finally{J(),C.value=!1,T(()=>{a.value&&(a.value.scrollTop=a.value.scrollHeight)})}},Z=e=>{if(!e)return"—";const s=new Date(e);return Number.isNaN(s.getTime())?e:s.toLocaleString("ru-RU")},ee=D(()=>{const e=(u.value?.contacts||[]).filter(o=>o.id!==i.user?.id),s=d.value?.[d.value.length-1]?.contact_user;if(!e.length)return s?.id&&s.id!==i.user?.id?[s]:[];if(!s?.id)return e;const t=[...e.filter(o=>o.id===s.id),...e.filter(o=>o.id!==s.id),...s.id!==i.user?.id&&!e.some(o=>o.id===s.id)?[s]:[]],c=[],f=new Set;for(const o of t)f.has(o.id)||(f.add(o.id),c.push(o));return c}),L=p(!1),le=async()=>{if(L.value||C.value)return;const e=x.value?.oldest_id;if(!e)return;L.value=!0;const s=a.value?.scrollHeight??0;N();try{await S({conversation_id:u.value?.id??"",include_conversations:0,messages_before_id:e,messages_limit:10},{force:!0})}finally{J(),T(()=>{if(a.value){const t=a.value.scrollHeight;a.value.scrollTop=t-s}L.value=!1})}},re=()=>{a.value&&a.value.scrollTop<=0&&x.value?.has_more&&le()},ne=async e=>{if(!e?.id)return;const s=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");try{const t=await fetch("/account/messages/conversations",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest",...s?{"X-CSRF-TOKEN":s}:{}},body:JSON.stringify({user_id:e.id})});if(!t.ok)return;const f=(await t.json())?.conversation_id;if(f){let o=v.value.find(R=>R.id===f);o||(o={id:f,type:"direct",title:e.login,other_user:{id:e.id,login:e.login},last_message:null,unread_count:0,updated_at:new Date().toISOString()},v.value=[o,...v.value]),h.value=f,u.value=o,Y(o),S({include_conversations:1})}}catch{}},O=p(""),E=p(""),P=p(!1),te=async()=>{const e=u.value?.id;if(!e||P.value)return;E.value="",P.value=!0;const s=O.value;O.value="";try{const t=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),c=await fetch(`/account/messages/conversations/${e}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest",...t?{"X-CSRF-TOKEN":t}:{}},body:JSON.stringify({body:s})});if(!c.ok){const f=await c.json();E.value=f?.errors?.recipient_id?.[0]||f?.errors?.message?.[0]||f?.errors?.body?.[0]||"Не удалось отправить сообщение.";return}}catch{E.value="Не удалось отправить сообщение.",O.value=s}finally{P.value=!1}},oe=e=>{(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&(e.preventDefault(),te())},ie=async e=>{if(!e)return;const s=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");await fetch(`/account/messages/messages/${e}/delete`,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest",...s?{"X-CSRF-TOKEN":s}:{}}}),await S({conversation_id:u.value?.id})};return(e,s)=>(r(),n("div",Ce,[s[8]||(s[8]=l("div",{class:"pointer-events-none absolute -left-28 top-12 h-72 w-72 rounded-full bg-emerald-200/70 blur-3xl"},null,-1)),s[9]||(s[9]=l("div",{class:"pointer-events-none absolute -right-24 -top-24 h-80 w-80 rounded-full bg-amber-200/70 blur-3xl"},null,-1)),l("div",Ne,[V(ye,{"app-name":m.appName,"is-authenticated":!!e.$page.props.auth?.user,"login-label":e.$page.props.auth?.user?.login,"sidebar-title":m.navigation.title,"sidebar-items":Q.value,"sidebar-active-href":m.activeHref},null,8,["app-name","is-authenticated","login-label","sidebar-title","sidebar-items","sidebar-active-href"]),l("main",{class:k(["grid gap-6",{"lg:grid-cols-[240px_1fr]":X.value}])},[X.value?(r(),se(we,{key:0,title:m.navigation.title,data:Q.value,"active-href":m.activeHref},null,8,["title","data","active-href"])):g("",!0),l("div",Te,[V(_e,{items:m.breadcrumbs},null,8,["items"]),s[7]||(s[7]=l("h1",{class:"text-3xl font-semibold text-slate-900"},"Сообщения",-1)),l("div",Me,[l("div",Ae,[s[1]||(s[1]=l("p",{class:"text-xs font-semibold uppercase tracking-[0.15em] text-slate-500"},"Диалоги",-1)),v.value.length?(r(),n("div",He,[(r(!0),n(U,null,W(I.value,t=>(r(),n("button",{key:t.id,type:"button",class:k(["w-full rounded-2xl border px-4 py-3 text-left transition",t.id===h.value?"border-[#444b5b] bg-[#444b5b] text-[#99aecc]":t.type==="system"?"border-sky-200 bg-white text-slate-700 hover:border-sky-300":"border-slate-200 bg-slate-50 text-slate-700 hover:border-slate-300"]),onClick:c=>Y(t)},[l("div",Re,[l("span",{class:k(t.id===h.value?"font-semibold text-white":"font-semibold")},_(t.title),3),t.unread_count?(r(),n("span",qe,_(t.unread_count>9?"…":t.unread_count),1)):g("",!0)]),t.last_message?(r(),n("p",{key:0,class:k(["mt-1 text-xs",t.id===h.value?"text-[#99aecc]":"text-slate-500"])},_(t.last_message.body),3)):g("",!0)],10,Oe))),128))])):(r(),n("div",je," Диалогов пока нет. "))]),l("div",Ee,[u.value?(r(),n("div",$e,[l("div",Xe,[s[2]||(s[2]=l("p",{class:"text-xs uppercase tracking-[0.15em] text-slate-500"},"Диалог",-1)),l("p",Be,_(u.value.title),1)]),l("div",{ref_key:"messagesContainer",ref:a,class:"min-h-0 flex-1 space-y-3 overflow-auto pr-1",onScroll:re},[C.value?(r(),n("div",Fe,[...s[3]||(s[3]=[l("div",{class:"h-6 w-6 animate-spin rounded-full border-2 border-slate-300 border-t-slate-600"},null,-1)])])):(r(),n(U,{key:1},[L.value?(r(),n("div",Le,[...s[4]||(s[4]=[l("div",{class:"h-4 w-4 animate-spin rounded-full border-2 border-slate-300 border-t-slate-600"},null,-1)])])):d.value.length&&!x.value?.has_more?(r(),n("p",Pe," Начало диалога ")):g("",!0),(r(!0),n(U,null,W(d.value,t=>(r(),n("div",{key:t.id,class:k(["flex",t.is_outgoing?"justify-end":"justify-start"])},[l("div",{class:k(["max-w-[80%] rounded-2xl px-4 py-3 text-sm",t.is_outgoing?"bg-[#444b5b] text-white":"bg-slate-100 text-slate-700"])},[t.title?(r(),n("p",Ue,_(t.title),1)):g("",!0),t.body?(r(),n("p",{key:1,class:k(t.title?"mt-2":"")},_(t.body),3)):g("",!0),t.link_url?(r(),se(he(be),{key:2,class:k(["mt-2 inline-flex text-xs font-semibold",t.is_outgoing?"text-amber-200 hover:text-amber-100":"text-slate-700 hover:text-slate-900"]),href:t.link_url},{default:pe(()=>[...s[5]||(s[5]=[ge(" Открыть ",-1)])]),_:1},8,["class","href"])):g("",!0),l("div",{class:k(["mt-2 flex items-center justify-between gap-3 text-[11px] text-slate-400",t.is_outgoing?"text-slate-300":""])},[l("div",Ie,[t.is_outgoing&&t.read_by_others_at?(r(),n("span",{key:0,class:"text-[11px] font-semibold text-emerald-200",title:`Прочитано ${Z(t.read_by_others_at)}`}," ✓ ",8,Ke)):g("",!0),l("span",null,_(Z(t.created_at)),1)]),t.is_outgoing?(r(),n("button",{key:0,type:"button",class:"text-[11px] font-semibold text-rose-200 hover:text-rose-100",onClick:c=>ie(t.id)}," Удалить ",8,Ve)):g("",!0)],2)],2)],2))),128))],64))],544),u.value?.type==="system"?(r(),n("div",We,[s[6]||(s[6]=l("p",{class:"text-xs uppercase tracking-[0.15em] text-slate-500"},"Контакты для ответа",-1)),l("div",ze,[(r(!0),n(U,null,W(ee.value,t=>(r(),n("button",{key:t.id,type:"button",class:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-left text-xs font-semibold text-slate-700 hover:border-slate-300 hover:text-slate-900",onClick:c=>ne(t)},[l("span",Ge,_(t.login),1),t.role?(r(),n("span",Qe,_(t.role),1)):g("",!0)],8,Je))),128))]),ee.value.length?g("",!0):(r(),n("p",Ye," Нет доступных контактов для ответа. "))])):(r(),n("form",{key:1,class:"mt-auto space-y-2",onSubmit:ve(te,["prevent"])},[fe(l("textarea",{"onUpdate:modelValue":s[0]||(s[0]=t=>O.value=t),class:"min-h-[96px] w-full rounded-2xl border border-slate-200 px-3 py-2 text-sm text-slate-700",placeholder:"Введите сообщение (Ctrl+Enter)",onKeydown:oe},null,544),[[me,O.value]]),E.value?(r(),n("div",Ze,_(E.value),1)):g("",!0),l("div",et,[l("button",{class:"rounded-full border border-slate-900 bg-slate-900 px-4 py-2 text-sm font-semibold text-white transition hover:-translate-y-0.5 hover:bg-slate-800 disabled:cursor-not-allowed disabled:border-slate-300 disabled:bg-slate-200 disabled:text-slate-500 disabled:hover:translate-y-0",type:"submit",disabled:!O.value||P.value}," Отправить ",8,tt)])],32))])):(r(),n("div",De," Выберите диалог слева, чтобы увидеть переписку. "))])])])],2),V(ke,{"app-name":m.appName},null,8,["app-name"])])]))}};export{nt as default};
